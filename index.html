<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر Skare</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Simple Font Configuration */
        body { font-family: 'Cairo', sans-serif; }
        /* You can add Google Fonts link here if needed */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- قاموس الترجمة ---
        const translations = {
          ar: { 
            searchPlaceholder: "ابحث عن منتج...",
            shoppingCart: "سلة التسوق", myAccount: "حسابي", dashboard: "لوحة التحكم", logout: "تسجيل الخروج", login: "تسجيل الدخول", storeSlogan: "متجرك الأول لمنتجات العناية الفاخرة.", facebook: "فيسبوك", instagram: "انستغرام", twitter: "تويتر", rightsReserved: "جميع الحقوق محفوظة.", welcomeMessage: "اكتشفي جمالكِ الطبيعي", welcomeSubMessage: "مجموعة مختارة بعناية لأجلكِ", noProductsFound: "لم يتم العثور على منتجات تطابق بحثك.", productNotFound: "المنتج غير موجود.", addToCart: "أضف للسلة", currency: "ج.م", cartTitle: "سلة التسوق", emptyCart: "سلة التسوق فارغة.", orderSummary: "ملخص الطلب", total: "الإجمالي", checkout: "إتمام الشراء", remove: "إزالة", accountTitle: "حسابي", welcomeUser: "مرحباً بك،", orderHistory: "سجل الطلبات", loadingOrders: "جاري تحميل طلباتك...", noOrders: "لا يوجد لديك طلبات سابقة.", orderNumber: "طلب رقم:", orderDate: "التاريخ:", loginTitle: "تسجيل الدخول", signupTitle: "إنشاء حساب جديد", emailPlaceholder: "البريد الإلكتروني", passwordPlaceholder: "كلمة المرور", loginButton: "تسجيل الدخول", signupButton: "إنشاء حساب", switchToSignup: "ليس لديك حساب؟", switchToLogin: "لديك حساب بالفعل؟", loginSuccess: "تم تسجيل الدخول بنجاح!", signupSuccess: "تم إنشاء الحساب بنجاح!", authError: "البريد الإلكتروني أو كلمة المرور غير صحيحة.", addedToCart: "تمت الإضافة للسلة!", loginToCheckout: "يرجى تسجيل الدخول لإتمام الشراء.", emptyCartError: "سلة التسوق فارغة.", orderSuccess: "تم إرسال طلبك بنجاح!", orderError: "حدث خطأ أثناء الطلب.", logoutSuccess: "تم تسجيل الخروج.", loginToAdd: "يرجى تسجيل الدخول للإضافة للسلة.",
            fullNamePlaceholder: "الاسم الكامل", phonePlaceholder: "رقم الهاتف", 
            invalidPhoneError: "رقم الهاتف غير صحيح. يجب أن يبدأ بـ 010, 011, 012, أو 015 ويتكون من 11 رقم.",
            addressPlaceholder: "العنوان",
            detailedAddressPlaceholder: "العنوان بالتفصيل (الشارع، رقم المنزل، علامة مميزة)",
            profileInfo: "معلومات الملف الشخصي", loadingProfile: "جاري تحميل الملف الشخصي...",
            rateLimitError: "لقد حاولت عدة مرات. لأسباب أمنية، يرجى الانتظار دقيقة ثم المحاولة مرة أخرى.",
            userAlreadyRegisteredError: "هذا البريد الإلكتروني مسجل بالفعل. هل تريد تسجيل الدخول بدلاً من ذلك؟",
            allCategories: "كل الأقسام",
            bucketNotFound_admin: "خطأ: حاوية تخزين الصور 'products' غير موجودة. يرجى إنشائها من قسم Storage في لوحة تحكم Supabase.",
            shippingDetails: "معلومات التوصيل", selectCity: "ابحث عن مدينتك...", deliveryFee: "رسوم التوصيل", subtotal: "المجموع الفرعي", finalTotal: "المجموع النهائي", completeOrder: "تأكيد الطلب", pleaseFillShipping: "يرجى إكمال جميع بيانات التوصيل.",
            // أكواد الخصم
            coupons: "أكواد الخصم", applyCoupon: "تطبيق", couponCode: "كود الخصم", enterCoupon: "أدخل كود الخصم...", couponApplied: "تم تطبيق الخصم بنجاح!", invalidCoupon: "كود الخصم غير صالح أو منتهي الصلاحية.", couponUserLimitReached: "لقد استخدمت هذا الكود الحد الأقصى من المرات.", couponTotalLimitReached: "انتهى استخدام هذا الكود.", discount: "الخصم", manageCoupons: "إدارة أكواد الخصم", addCoupon: "إضافة كود جديد", discountPercentage: "نسبة الخصم (%)", maxUsers: "الحد الأقصى للمستخدمين", usesPerUser: "الاستخدام لكل مستخدم",
            parentCategory: "القسم الرئيسي", selectParentCategory: "اختر القسم الرئيسي (اختياري)",
            // لوحة التحكم
            adminPanel: "لوحة تحكم الأدمن", overview: "نظرة عامة", products: "المنتجات", categories: "الأقسام", users: "المستخدمون", analytics: "التحليلات", orders: "الطلبات", manageOrders: "إدارة الطلبات", orderStatus: "حالة الطلب", customerName: "اسم العميل", customerPhone: "هاتف العميل", city: "المدينة", newStatus: "جديد", shippedStatus: "تم الشحن", deliveredStatus: "تم التوصيل", updateStatus: "تحديث الحالة", orderDetails: "تفاصيل الطلب",
            manageProducts: "إدارة المنتجات", addProduct: "إضافة منتج جديد", productName: "اسم المنتج", productDesc: "وصف المنتج", price: "السعر", salePrice: "سعر العرض (اختياري)", imageUrl: "رابط الصورة", category: "القسم", save: "حفظ", cancel: "إلغاء", edit: "تعديل", delete: "حذف", confirmDelete: "هل أنت متأكد من الحذف؟", manageCategories: "إدارة الأقسام", addCategory: "إضافة قسم جديد", categoryName: "اسم القسم", manageUsers: "إدارة المستخدمين", userEmail: "البريد الإلكتروني", fullName: "الاسم الكامل", phone: "الهاتف", status: "الحالة", action: "الإجراء", block: "حظر", unblock: "إلغاء الحظر", active: "نشط", blocked: "محظور", salesAnalytics: "تحليلات المبيعات",
            totalSales30d: "إجمالي المبيعات (آخر 30 يوم)",
            mostSold: "الأكثر مبيعاً", leastSold: "الأقل مبيعاً", topCustomers: "أفضل العملاء", salesByCategory: "المبيعات حسب القسم", smartTips: "نصائح ذكية", tip1: "منتج %s هو الأكثر مبيعاً، فكّر في عرضه بالصفحة الرئيسية.", tip2: "قسم %s لديه أقل مبيعات، قد تفيد إضافة عروض عليه.", tip3: "تهانينا! المبيعات ارتفعت هذا الشهر.", noData: "لا توجد بيانات كافية.",
            uploadImage: "اختر صورة المنتج...", noImageSelected: "لم يتم اختيار صورة."
          },
          en: { 
            searchPlaceholder: "Search for a product...", shoppingCart: "Shopping Cart", myAccount: "My Account", dashboard: "Dashboard", logout: "Logout", login: "Login", storeSlogan: "Your first destination for luxury care products.", facebook: "Facebook", instagram: "Instagram", twitter: "Twitter", rightsReserved: "All rights reserved.", welcomeMessage: "Discover Your Natural Beauty", welcomeSubMessage: "A collection carefully selected for you", noProductsFound: "No products found matching your search.", productNotFound: "Product not found.", addToCart: "Add to Cart", currency: "EGP", cartTitle: "Shopping Cart", emptyCart: "Your shopping cart is empty.", orderSummary: "Order Summary", total: "Total", checkout: "Checkout", remove: "Remove", accountTitle: "My Account", welcomeUser: "Welcome,", orderHistory: "Order History", loadingOrders: "Loading your orders...", noOrders: "You have no previous orders.", orderNumber: "Order #:", orderDate: "Date:", loginTitle: "Login", signupTitle: "Create a New Account", emailPlaceholder: "Email Address", passwordPlaceholder: "Password", loginButton: "Login", signupButton: "Create Account", switchToSignup: "Don't have an account?", switchToLogin: "Already have an account?", loginSuccess: "Logged in successfully!", signupSuccess: "Account created successfully!", authError: "Incorrect email or password.", addedToCart: "Added to cart!", loginToCheckout: "Please log in to complete your purchase.", emptyCartError: "The shopping cart is empty.", orderSuccess: "Your order has been placed successfully!", orderError: "An error occurred while placing the order.", logoutSuccess: "Logged out successfully.", loginToAdd: "Please log in to add items to your cart.",
            fullNamePlaceholder: "Full Name", phonePlaceholder: "Phone Number", 
            invalidPhoneError: "Invalid phone number. It must start with 010, 011, 012, or 015 and be 11 digits long.",
            addressPlaceholder: "Address",
            detailedAddressPlaceholder: "Detailed Address (Street, house number, landmark)",
            profileInfo: "Profile Information", loadingProfile: "Loading profile...",
            rateLimitError: "You have tried too many times. For security reasons, please wait a minute and try again.",
            userAlreadyRegisteredError: "This email is already registered. Would you like to log in instead?",
            allCategories: "All Categories",
            bucketNotFound_admin: "Error: Storage bucket 'products' not found. Please create it from the Storage section in your Supabase dashboard.",
            shippingDetails: "Shipping Details", selectCity: "Search for your city...", deliveryFee: "Delivery Fee", subtotal: "Subtotal", finalTotal: "Final Total", completeOrder: "Confirm Order", pleaseFillShipping: "Please complete all shipping details.",
            // Discount Codes
            coupons: "Discount Codes", applyCoupon: "Apply", couponCode: "Coupon Code", enterCoupon: "Enter coupon code...", couponApplied: "Coupon applied successfully!", invalidCoupon: "Invalid or expired coupon code.", couponUserLimitReached: "You have reached the usage limit for this coupon.", couponTotalLimitReached: "This coupon has reached its total usage limit.", discount: "Discount", manageCoupons: "Manage Coupons", addCoupon: "Add New Coupon", discountPercentage: "Discount Percentage (%)", maxUsers: "Max Users", usesPerUser: "Uses Per User",
            parentCategory: "Parent Category", selectParentCategory: "Select Parent Category (Optional)",
            // Admin Dashboard
            adminPanel: "Admin Panel", overview: "Overview", products: "Products", categories: "Categories", users: "Users", analytics: "Analytics", orders: "Orders", manageOrders: "Manage Orders", orderStatus: "Order Status", customerName: "Customer Name", customerPhone: "Customer Phone", city: "City", newStatus: "New", shippedStatus: "Shipped", deliveredStatus: "Delivered", updateStatus: "Update Status", orderDetails: "Order Details",
            manageProducts: "Manage Products", addProduct: "Add New Product", productName: "Product Name", productDesc: "Product Description", price: "Price", salePrice: "Sale Price (Optional)", imageUrl: "Image URL", category: "Category", save: "Save", cancel: "Cancel", edit: "Edit", delete: "Delete", confirmDelete: "Are you sure you want to delete?", manageCategories: "Manage Categories", addCategory: "Add New Category", categoryName: "Category Name", manageUsers: "Manage Users", userEmail: "Email", fullName: "Full Name", phone: "Phone", status: "Status", action: "Action", block: "Block", unblock: "Unblock", active: "Active", blocked: "Blocked", salesAnalytics: "Sales Analytics",
            totalSales30d: "Total Sales (Last 30 Days)",
            mostSold: "Most Sold Products", leastSold: "Least Sold Products", topCustomers: "Top Customers", salesByCategory: "Sales by Category", smartTips: "Smart Tips", tip1: "Product %s is a top seller. Consider featuring it on the homepage.", tip2: "Category %s has the lowest sales. A special offer might boost it.", tip3: "Congratulations! Sales have increased this month.", noData: "Not enough data available.",
            uploadImage: "Choose product image...", noImageSelected: "No image selected."
          }
        };

        const ShoppingBagIcon = (props) => ( <svg {...props} xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg> );
        const UserIcon = (props) => ( <svg {...props} xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> );
        const SearchIcon = (props) => ( <svg {...props} xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> );
        const GlobeIcon = (props) => ( <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A11.953 11.953 0 0012 13.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 003 12c0 .778.099 1.533.284 2.253m0 0c1.357 2.427 3.379 4.33 5.579 5.522" /></svg> );

        const SUPABASE_URL = 'https://coshixxmfixtzeaotkte.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvc2hpeHhtZml4dHplYW90a3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkxOTMsImV4cCI6MjA3MTY3NTE5M30.kmjW9FlVpMgVUETZxJhofJdpZWFxFUpHipBoyNxwGd0';
        const ADMIN_EMAIL = "ziadkishkaastaly@gmail.com";

        const Toast = ({ message, type, onClose }) => { if (!message) return null; const baseStyle = "fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50"; const typeStyle = type === 'success' ? 'bg-green-500' : 'bg-red-500'; useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]); return <div className={`${baseStyle} ${typeStyle}`}>{message}</div>; };
        const LoadingSpinner = () => ( <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-pink-600"></div></div> );
        const Modal = ({ children, onClose }) => ( <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div className="bg-white p-8 rounded-lg shadow-2xl relative w-full max-w-lg max-h-[90vh] overflow-y-auto"><button onClick={onClose} className="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-3xl z-10">&times;</button>{children}</div></div> );

        const AuthPage = ({ supabase, setNotification, t }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [fullName, setFullName] = useState(''); const [phone, setPhone] = useState(''); const [address, setAddress] = useState(''); const [isLogin, setIsLogin] = useState(true);
            
            const handleAuth = async (e) => {
                e.preventDefault(); if (!supabase) return;
                try {
                    if (isLogin) {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        setNotification({ type: 'success', messageKey: 'loginSuccess' });
                    } else {
                        const phoneRegex = /^(010|011|012|015)\d{8}$/;
                        if (!phoneRegex.test(phone)) {
                            setNotification({ type: 'error', messageKey: 'invalidPhoneError' });
                            return; 
                        }

                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { 
                                    full_name: fullName, 
                                    phone: phone, 
                                    address: address 
                                }
                            }
                        });
                        if (error) throw error;
                        setNotification({ type: 'success', messageKey: 'signupSuccess' });
                    }
                } catch (error) {
                    console.error("Authentication error object:", error);
                    if (error.message.includes('User already registered')) {
                        setNotification({ type: 'error', messageKey: 'userAlreadyRegisteredError' });
                    } else if (error.message.includes('For security purposes')) {
                        setNotification({ type: 'error', messageKey: 'rateLimitError' });
                    } else {
                        setNotification({ type: 'error', messageKey: 'authError' });
                    }
                }
            };

            return ( <div className="flex items-center justify-center min-h-screen bg-pink-50"><div className="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg"><h2 className="text-3xl font-extrabold text-center text-gray-900">{isLogin ? t('loginTitle') : t('signupTitle')}</h2><form className="mt-8 space-y-6" onSubmit={handleAuth}>{!isLogin && ( <> <input type="text" value={fullName} onChange={(e) => setFullName(e.target.value)} className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm" placeholder={t('fullNamePlaceholder')} required /> <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 sm:text-sm" placeholder={t('phonePlaceholder')} required /> <input type="text" value={address} onChange={(e) => setAddress(e.target.value)} className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 sm:text-sm" placeholder={t('addressPlaceholder')} required /> </> )} <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className={`appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 ${isLogin ? 'rounded-t-md' : ''} focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm`} placeholder={t('emailPlaceholder')} required /> <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm" placeholder={t('passwordPlaceholder')} required /> <button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700">{isLogin ? t('loginButton') : t('signupButton')}</button></form><div className="text-sm text-center"><button onClick={() => setIsLogin(!isLogin)} className="font-medium text-pink-600 hover:text-pink-500">{isLogin ? t('switchToSignup') : t('switchToLogin')}</button></div></div></div> );
        };

        const Header = ({ user, isAdmin, onLogout, setPage, setSearchTerm, cartItemCount, t, toggleLanguage, language }) => { 
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            return ( <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40"><nav className="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center"><button onClick={() => setPage('home')} className="text-3xl font-bold text-pink-600 tracking-wider font-serif">Skare</button><div className="hidden md:flex flex-grow items-center justify-center px-10"><div className="relative w-full max-w-lg"><input type="text" placeholder={t('searchPlaceholder')} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-full focus:ring-pink-500 focus:border-pink-500" /><div className="absolute left-3 top-1/2 -translate-y-1/2"><SearchIcon /></div></div></div><div className="flex items-center space-x-2 sm:space-x-4"><button onClick={toggleLanguage} className="text-gray-600 hover:text-pink-600 flex items-center gap-1 p-2 rounded-md hover:bg-gray-100" title="Change Language"><GlobeIcon /><span className="font-semibold">{language === 'ar' ? 'EN' : 'AR'}</span></button><button onClick={() => setPage('cart')} className="relative text-gray-600 hover:text-pink-600" title={t('shoppingCart')}><ShoppingBagIcon />{cartItemCount > 0 && <span className="absolute -top-2 -right-2 bg-pink-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{cartItemCount}</span>}</button>{user ? (<div className="relative"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-gray-600 hover:text-pink-600" title={t('myAccount')}><UserIcon /></button>{isMenuOpen && (<div className={`absolute mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 ${language === 'ar' ? 'left-0' : 'right-0'}`}><span className="block px-4 py-2 text-sm text-gray-500 truncate">{user.email}</span><button onClick={() => { setPage('account'); setIsMenuOpen(false); }} className={`block w-full px-4 py-2 text-sm text-gray-700 hover:bg-pink-50 ${language === 'ar' ? 'text-right' : 'text-left'}`}>{t('myAccount')}</button>{isAdmin && <button onClick={() => { setPage('dashboard'); setIsMenuOpen(false); }} className={`block w-full px-4 py-2 text-sm text-gray-700 hover:bg-pink-50 ${language === 'ar' ? 'text-right' : 'text-left'}`}>{t('dashboard')}</button>}<button onClick={() => { onLogout(); setIsMenuOpen(false); }} className={`block w-full px-4 py-2 text-sm text-gray-700 hover:bg-pink-50 ${language === 'ar' ? 'text-right' : 'text-left'}`}>{t('logout')}</button></div>)}</div>) : (<button onClick={() => setPage('auth')} className="text-gray-600 hover:text-pink-600" title={t('login')}><UserIcon /></button>)}</div></nav></header> );
        };
        const Footer = ({ t }) => { return ( <footer className="bg-white border-t mt-12"><div className="container mx-auto px-6 py-8"><div className="flex flex-col items-center text-center"><h2 className="text-2xl font-bold text-pink-600 font-serif">Skare</h2><p className="max-w-md mx-auto mt-2 text-gray-500">{t('storeSlogan')}</p><div className="flex mt-4 space-x-4"><a href="#" className="text-gray-400 hover:text-pink-500">{t('facebook')}</a><a href="#" className="text-gray-400 hover:text-pink-500">{t('instagram')}</a><a href="#" className="text-gray-400 hover:text-pink-500">{t('twitter')}</a></div></div><div className="mt-8 border-t border-gray-200 pt-4"><p className="text-center text-gray-400 text-sm">&copy; {new Date().getFullYear()} Skare. {t('rightsReserved')}</p></div></div></footer> );};
        
        const ProductCard = ({ product, onProductClick, onAddToCart, t }) => { 
            const hasSale = product.sale_price && product.sale_price < product.price; 
            return ( 
                <div className="bg-white rounded-lg shadow-lg overflow-hidden group transition-transform duration-300 hover:-translate-y-2 flex flex-col">
                    <button onClick={() => onProductClick(product.id)} className="w-full text-right">
                        <div className="relative">
                            <img src={product.image_url} alt={product.name} className="w-full h-56 object-cover"/>
                            {hasSale && <div className="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">عرض</div>}
                        </div>
                        <div className="p-4 flex flex-col flex-grow">
                            <h3 className="text-lg font-semibold text-gray-800 truncate">{product.name}</h3>
                            <div className="mt-4 flex items-center justify-between">
                                {hasSale ? (
                                    <div>
                                        <p className="text-xl font-bold text-red-500">{product.sale_price} {t('currency')}</p>
                                        <p className="text-sm text-gray-500 line-through">{product.price} {t('currency')}</p>
                                    </div>
                                ) : (
                                    <p className="text-xl font-bold text-pink-600">{product.price} {t('currency')}</p>
                                )}
                            </div>
                        </div>
                    </button>
                    <div className="p-4 pt-0 mt-auto">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onAddToCart(product); }} 
                            className="w-full bg-pink-100 text-pink-700 font-bold py-2 px-4 rounded-lg hover:bg-pink-200 transition-colors text-sm"
                        >
                            {t('addToCart')}
                        </button>
                    </div>
                </div> 
            );
        };
        
        const HomePage = ({ products, categories, selectedCategory, setSelectedCategory, searchTerm, onProductClick, onAddToCart, t }) => { 
            const [openSubCategories, setOpenSubCategories] = useState({});

            const categoryTree = useMemo(() => {
                const tree = [];
                const childrenOf = {};
                categories.forEach(cat => {
                    if (cat.parent_id) {
                        if (!childrenOf[cat.parent_id]) {
                            childrenOf[cat.parent_id] = [];
                        }
                        childrenOf[cat.parent_id].push(cat);
                    } else {
                        tree.push(cat);
                    }
                });
                tree.forEach(cat => {
                    cat.children = childrenOf[cat.id] || [];
                });
                return tree;
            }, [categories]);

            const filteredProducts = useMemo(() => { 
                if (selectedCategory === null) {
                    return products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }
                const selectedCat = categories.find(c => c.id === selectedCategory);
                const childrenIds = selectedCat && categoryTree.find(c => c.id === (selectedCat.parent_id || selectedCat.id))
                    ?.children.map(c => c.id) || [];
                const categoryIdsToFilter = [selectedCategory, ...childrenIds];

                return products
                    .filter(p => categoryIdsToFilter.includes(p.category_id))
                    .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())); 
            }, [products, searchTerm, selectedCategory, categories, categoryTree]);

            const toggleSubCategory = (categoryId) => {
                setOpenSubCategories(prev => ({...prev, [categoryId]: !prev[categoryId]}));
            };

            return ( 
                <main className="container mx-auto p-6">
                    <div className="text-center mb-12">
                        <h1 className="text-4xl font-extrabold text-gray-800">{t('welcomeMessage')}</h1>
                        <p className="text-lg text-gray-600 mt-2">{t('welcomeSubMessage')}</p>
                    </div>
                    
                    <div className="flex justify-center flex-wrap gap-2 mb-8">
                        <button onClick={() => setSelectedCategory(null)} className={`px-4 py-2 rounded-full font-semibold transition-colors ${selectedCategory === null ? 'bg-pink-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{t('allCategories')}</button>
                        {categoryTree.map(cat => (
                            <div key={cat.id} className="relative">
                                <button onClick={() => { setSelectedCategory(cat.id); toggleSubCategory(cat.id);}} className={`px-4 py-2 rounded-full font-semibold transition-colors ${selectedCategory === cat.id ? 'bg-pink-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{cat.name}</button>
                                {cat.children.length > 0 && openSubCategories[cat.id] && (
                                     <div className="flex flex-col mt-2 space-y-2">
                                        {cat.children.map(child => (
                                            <button key={child.id} onClick={(e) => { e.stopPropagation(); setSelectedCategory(child.id); }} className={`px-4 py-2 rounded-full font-semibold transition-colors text-sm ${selectedCategory === child.id ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>- {child.name}</button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {products.length > 0 ? ( 
                        filteredProducts.length > 0 ? ( 
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                                {filteredProducts.map(product => <ProductCard key={product.id} product={product} onProductClick={onProductClick} onAddToCart={onAddToCart} t={t} />)}
                            </div> 
                        ) : ( 
                            <div className="text-center py-16"><p className="text-xl text-gray-500">{t('noProductsFound')}</p></div> 
                        ) 
                    ) : ( 
                        <div className="text-center py-16"><p className="text-xl text-gray-500">لا توجد منتجات حالياً. أضف أول منتج لك من لوحة التحكم!</p></div> 
                    )} 
                </main> 
            );
        };

        const ProductDetailPage = ({ productId, products, addToCart, setNotification, t }) => { const [product, setProduct] = useState(null); useEffect(() => { setProduct(products.find(p => p.id === productId)); }, [productId, products]); if (!product) return <div className="text-center py-20">{t('productNotFound')}</div>; const hasSale = product.sale_price && product.sale_price < product.price; return ( <div className="container mx-auto p-6"><div className="grid md:grid-cols-2 gap-10"><div><img src={product.image_url} alt={product.name} className="w-full rounded-lg shadow-lg"/></div><div className="space-y-4"><h1 className="text-4xl font-bold">{product.name}</h1><div className="flex items-baseline space-x-2">{hasSale ? ( <><p className="text-3xl font-bold text-red-500">{product.sale_price} {t('currency')}</p><p className="text-xl text-gray-400 line-through">{product.price} {t('currency')}</p></> ) : (<p className="text-3xl font-bold text-pink-600">{product.price} {t('currency')}</p>)}</div><p className="text-gray-600 leading-relaxed">{product.description}</p><button onClick={() => { addToCart(product); setNotification({ type: 'success', messageKey: 'addedToCart' }); }} className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition-colors text-lg">{t('addToCart')}</button></div></div></div> );};
        
        const CartPage = ({ supabase, cart, updateQuantity, removeFromCart, setNotification, user, setPage, t }) => {
            const deliveryCities = [ { name: 'قلين', fee: 15 }, { name: 'عمارات المنطاوي', fee: 15 }, { name: 'الشين', fee: 45 }, { name: 'جوده', fee: 30 }, { name: 'المرازقة', fee: 50 }, { name: 'المنشية الكبيرة', fee: 50 }, { name: 'حصة الغنيمي', fee: 65 }, { name: 'شباس عمير', fee: 55 }, { name: 'شباس الشهداء', fee: 65 }, { name: 'البكاتوش', fee: 45 }, { name: 'كومبليده', fee: 45 }, { name: 'المرور', fee: 25 }, { name: 'اوزمان', fee: 45 }, { name: 'الجزاير', fee: 55 }, { name: 'الكردي', fee: 35 }, { name: 'الحناوي', fee: 30 }, { name: 'المنيا', fee: 30 }, { name: 'اونه', fee: 40 }, { name: 'المنشلين', fee: 45 }, { name: 'الشازلي', fee: 55 }, { name: 'ابوحميد', fee: 65 }, { name: 'الباشا', fee: 65 }, { name: 'صروة', fee: 15 }, { name: 'كفر ابو حطب', fee: 35 }, { name: 'كفر ابو طور', fee: 35 }, { name: 'كفر ابو ناعم', fee: 55 }, { name: 'عزبة مشرف', fee: 30 }, { name: 'الاطرش', fee: 35 }, { name: 'عزبة الباسل', fee: 35 }, { name: 'عزبة الخميسن', fee: 30 }, { name: 'عزبة عبد الكريم', fee: 30 }, { name: 'عين الحياة', fee: 40 }, { name: 'شنو', fee: 55 }, { name: 'عزبة رجب', fee: 25 }, { name: 'العزبة البيضة', fee: 35 }, { name: 'ابو اسماعيل', fee: 30 }, { name: 'اللمعي', fee: 35 }, { name: 'المنشية الصغيرة', fee: 35 }, { name: 'شاهين', fee: 45 }, { name: 'نشرت', fee: 45 }, { name: 'طويلة نشرت', fee: 50 }, { name: 'حنس', fee: 55 }, { name: 'الخبي', fee: 55 }, { name: 'زمزم', fee: 50 }, { name: 'ميت الديبة', fee: 55 }, { name: 'ابو الجدايل', fee: 50 }, { name: 'الشقة', fee: 75 }, { name: 'عزبة شلبي', fee: 30 }, { name: 'عزبة عفيفية', fee: 35 }, { name: 'الزعويلي', fee: 35 }, { name: 'عشوش', fee: 45 }, { name: 'ابو شنب', fee: 50 }, { name: 'شبراطة', fee: 50 } ];
            
            const [shippingInfo, setShippingInfo] = useState({ name: '', phone: '', city: '', detailedAddress: '' });
            const [selectedCityFee, setSelectedCityFee] = useState(0);
            const [couponCodeInput, setCouponCodeInput] = useState('');
            const [appliedCoupon, setAppliedCoupon] = useState(null);
            const [discountAmount, setDiscountAmount] = useState(0);
            const [couponError, setCouponError] = useState('');

            useEffect(() => {
                if (user && supabase) {
                    const fetchProfile = async () => {
                        const { data } = await supabase.from('profiles').select('full_name, phone').eq('id', user.id).single();
                        if (data) {
                            setShippingInfo(prev => ({ ...prev, name: data.full_name || '', phone: data.phone || '' }));
                        }
                    };
                    fetchProfile();
                }
            }, [user, supabase]);

            const handleCityChange = (e) => {
                const cityName = e.target.value;
                const city = deliveryCities.find(c => c.name === cityName);
                setSelectedCityFee(city ? city.fee : 0);
                setShippingInfo(prev => ({ ...prev, city: cityName }));
            };

            const subtotal = useMemo(() => cart.reduce((sum, item) => sum + ((item.products?.sale_price || item.products?.price) * item.quantity), 0), [cart]);
            
            const handleApplyCode = async () => {
                if (!couponCodeInput) return;
                setCouponError('');
                
                const { data: code, error } = await supabase
                    .from('discount_codes')
                    .select('*')
                    .eq('code', couponCodeInput)
                    .eq('is_active', true)
                    .single();

                if (error || !code) {
                    setCouponError(t('invalidCoupon'));
                    return;
                }

                const { count: totalUses, error: totalUsesError } = await supabase
                    .from('used_codes')
                    .select('*', { count: 'exact', head: true })
                    .eq('code_id', code.id);
                
                if (totalUses >= code.max_users) {
                    setCouponError(t('couponTotalLimitReached'));
                    return;
                }
                
                const { count: userUses, error: userUsesError } = await supabase
                    .from('used_codes')
                    .select('*', { count: 'exact', head: true })
                    .eq('code_id', code.id)
                    .eq('user_id', user.id);

                if (userUses >= code.uses_per_user) {
                    setCouponError(t('couponUserLimitReached'));
                    return;
                }
                
                setAppliedCoupon(code);
                setDiscountAmount((subtotal * code.discount_percentage) / 100);
                setNotification({ type: 'success', messageKey: 'couponApplied' });
            };

            const finalTotal = subtotal - discountAmount + selectedCityFee;

            const handleCheckout = async () => { 
                if (!user) { setNotification({ type: 'error', messageKey: 'loginToCheckout' }); setPage('auth'); return; }
                if (cart.length === 0) { setNotification({ type: 'error', messageKey: 'emptyCartError' }); return; }
                if (!shippingInfo.name || !shippingInfo.phone || !shippingInfo.city || !shippingInfo.detailedAddress) { 
                    setNotification({ type: 'error', messageKey: 'pleaseFillShipping' }); return; 
                }
                
                const { data: orderData, error } = await supabase.from('orders').insert([{ 
                    user_id: user.id, 
                    total: finalTotal, 
                    items: cart.map(item => ({ product_id: item.product_id, name: item.products.name, quantity: item.quantity, price: (item.products.sale_price || item.products.price) })),
                    shipping_details: { ...shippingInfo, delivery_fee: selectedCityFee },
                    applied_discount_code: appliedCoupon ? appliedCoupon.code : null,
                    discount_amount: discountAmount
                }]).select().single(); 
                
                if(error) { 
                    setNotification({type: 'error', messageKey: 'orderError'}); 
                    console.error(error); 
                } else { 
                    if (appliedCoupon && orderData) {
                        await supabase.from('used_codes').insert({ code_id: appliedCoupon.id, user_id: user.id, order_id: orderData.id });
                    }
                    const { error: deleteError } = await supabase.from('cart_items').delete().eq('user_id', user.id); 
                    if(deleteError) console.error(deleteError); 
                    setNotification({type: 'success', messageKey: 'orderSuccess'}); 
                    setPage('account'); 
                } 
            }; 

            return ( 
                <div className="container mx-auto p-6 min-h-[calc(100vh-300px)]">
                    <h1 className="text-3xl font-bold text-gray-800 mb-6">{t('cartTitle')}</h1>
                    {cart.length === 0 ? ( <p className="text-center text-gray-500 py-16">{t('emptyCart')}</p> ) : ( 
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                            <div className="lg:col-span-2 space-y-4">
                                {cart.map(item => ( 
                                    <div key={item.product_id} className="flex items-center bg-white p-4 rounded-lg shadow">
                                        <img src={item.products?.image_url} alt={item.products?.name} className="w-20 h-20 object-cover rounded mr-4 ml-4"/>
                                        <div className="flex-grow">
                                            <h3 className="font-semibold">{item.products?.name}</h3>
                                            <p className="text-sm text-gray-600">{(item.products?.sale_price || item.products?.price)} {t('currency')}</p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => updateQuantity(item.product_id, item.quantity - 1)} className="px-2 py-1 bg-gray-200 rounded">-</button>
                                            <span>{item.quantity}</span>
                                            <button onClick={() => updateQuantity(item.product_id, item.quantity + 1)} className="px-2 py-1 bg-gray-200 rounded">+</button>
                                        </div>
                                        <button onClick={() => removeFromCart(item.product_id)} className="text-red-500 mx-4 hover:underline">{t('remove')}</button>
                                    </div> 
                                ))}
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow h-fit space-y-4">
                                <h2 className="text-xl font-bold mb-4">{t('shippingDetails')}</h2>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('fullNamePlaceholder')}</label>
                                    <input type="text" value={shippingInfo.name} onChange={e => setShippingInfo(p => ({...p, name: e.target.value}))} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required />
                                </div>
                                 <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('phonePlaceholder')}</label>
                                    <input type="tel" value={shippingInfo.phone} onChange={e => setShippingInfo(p => ({...p, phone: e.target.value}))} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('selectCity')}</label>
                                    <input list="cities" value={shippingInfo.city} onChange={handleCityChange} placeholder={t('selectCity')} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" required />
                                    <datalist id="cities">
                                        {deliveryCities.map(city => <option key={city.name} value={city.name} />)}
                                    </datalist>
                                </div>
                                 <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('detailedAddressPlaceholder')}</label>
                                    <textarea value={shippingInfo.detailedAddress} onChange={e => setShippingInfo(p => ({...p, detailedAddress: e.target.value}))} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" rows="2" placeholder={t('detailedAddressPlaceholder')} required></textarea>
                                </div>
                                <div className="border-t pt-4 space-y-2">
                                    <h2 className="text-xl font-bold">{t('orderSummary')}</h2>
                                    <div className="flex justify-between"><span>{t('subtotal')}</span><span>{subtotal.toFixed(2)} {t('currency')}</span></div>
                                    <div className="flex justify-between"><span>{t('deliveryFee')}</span><span>{selectedCityFee.toFixed(2)} {t('currency')}</span></div>
                                     {appliedCoupon && <div className="flex justify-between text-green-600"><span>{t('discount')} ({appliedCoupon.code})</span><span>-{discountAmount.toFixed(2)} {t('currency')}</span></div>}
                                    <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>{t('finalTotal')}</span><span>{finalTotal.toFixed(2)} {t('currency')}</span></div>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex gap-2">
                                        <input type="text" value={couponCodeInput} onChange={e => setCouponCodeInput(e.target.value.toUpperCase())} placeholder={t('enterCoupon')} className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500" />
                                        <button onClick={handleApplyCode} className="px-4 py-2 bg-gray-800 text-white font-semibold rounded-md hover:bg-gray-700">{t('applyCoupon')}</button>
                                    </div>
                                    {couponError && <p className="text-red-500 text-sm">{couponError}</p>}
                                </div>
                                <button onClick={handleCheckout} className="w-full mt-2 bg-pink-600 text-white font-bold py-2 rounded-lg hover:bg-pink-700 transition-colors">{t('completeOrder')}</button>
                            </div>
                        </div> 
                    )}
                </div> 
            );
        };
        const OrderHistoryPage = ({ supabase, user, t }) => { const [orders, setOrders] = useState([]); const [loading, setLoading] = useState(true); useEffect(() => { if(!supabase || !user) return; const fetchOrders = async () => { const { data, error } = await supabase.from('orders').select('*').eq('user_id', user.id).order('created_at', { ascending: false }); if(data) setOrders(data); setLoading(false); }; fetchOrders(); }, [supabase, user]); if(loading) return <div className="text-center py-20">{t('loadingOrders')}</div>; if(orders.length === 0) return <div className="text-center py-20">{t('noOrders')}</div>; return ( <div className="space-y-6"><h2 className="text-2xl font-bold">{t('orderHistory')}</h2>{orders.map(order => ( <div key={order.id} className="bg-white p-6 rounded-lg shadow"><div className="flex justify-between items-center border-b pb-2 mb-4"><div><p className="font-bold">{t('orderNumber')} #{String(order.id).slice(0, 8)}</p><p className="text-sm text-gray-500">{t('orderDate')} {new Date(order.created_at).toLocaleDateString()}</p></div><div className="text-lg font-bold text-pink-600">{order.total.toFixed(2)} {t('currency')}</div></div></div> ))}</div> );};
        const AccountPage = ({ supabase, user, t }) => {
            const [profile, setProfile] = useState(null); const [loadingProfile, setLoadingProfile] = useState(true);
            useEffect(() => { if (!supabase || !user) return; const fetchProfile = async () => { const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single(); if (data) setProfile(data); setLoadingProfile(false); }; fetchProfile(); }, [supabase, user]);
            return ( <div className="container mx-auto p-6"><h1 className="text-3xl font-bold mb-6">{t('accountTitle')}</h1><div className="bg-white p-6 rounded-lg shadow mb-8"><h2 className="text-xl font-semibold border-b pb-2 mb-4">{t('profileInfo')}</h2>{loadingProfile ? (<p>{t('loadingProfile')}</p>) : profile ? (<div className="space-y-2"><p><strong>{t('fullNamePlaceholder')}:</strong> {profile.full_name}</p><p><strong>{t('emailPlaceholder')}:</strong> {user.email}</p><p><strong>{t('phonePlaceholder')}:</strong> {profile.phone}</p><p><strong>{t('addressPlaceholder')}:</strong> {profile.address}</p></div>) : <p>{user.email}</p>}</div><OrderHistoryPage supabase={supabase} user={user} t={t} /></div> );
        };
        
        const CategoryManagement = ({ supabase, categories, fetchAllData, t, setNotification }) => {
            const [showModal, setShowModal] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [formData, setFormData] = useState({ name: '', parent_id: null });

            const categoryTree = useMemo(() => {
                const tree = [];
                const childrenOf = {};
                categories.forEach(cat => {
                    if (cat.parent_id) {
                        if (!childrenOf[cat.parent_id]) {
                            childrenOf[cat.parent_id] = [];
                        }
                        childrenOf[cat.parent_id].push(cat);
                    } else {
                        tree.push(cat);
                    }
                });
                tree.forEach(cat => {
                    cat.children = childrenOf[cat.id] || [];
                });
                return tree;
            }, [categories]);

            const handleOpenModal = (category = null) => {
                setEditingCategory(category);
                setFormData(category ? { name: category.name, parent_id: category.parent_id } : { name: '', parent_id: null });
                setShowModal(true);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                let error;
                const dataToSubmit = {
                    name: formData.name,
                    parent_id: formData.parent_id === 'null' ? null : formData.parent_id
                };
                if (editingCategory) {
                    ({ error } = await supabase.from('categories').update(dataToSubmit).eq('id', editingCategory.id));
                } else {
                    ({ error } = await supabase.from('categories').insert(dataToSubmit));
                }
                if (!error) {
                    fetchAllData();
                    setShowModal(false);
                } else {
                    console.error("Supabase error:", error);
                }
            };

            const handleDelete = async (categoryId) => {
                if (window.confirm(t('confirmDelete'))) {
                    // The database will now handle unlinking products and child categories automatically via 'ON DELETE SET NULL'
                    const { error } = await supabase.from('categories').delete().eq('id', categoryId);
                    if (error) {
                        console.error("Error deleting category:", error);
                        alert('حدث خطأ أثناء حذف القسم: ' + error.message);
                    } else {
                        fetchAllData();
                    }
                }
            };
            
            const renderCategoryRow = (cat, level = 0) => {
                return (
                    <React.Fragment key={cat.id}>
                        <tr>
                            <td className="px-6 py-4 whitespace-nowrap" style={{ paddingLeft: `${level * 20}px` }}>{level > 0 && '- '}{cat.name}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onClick={() => handleOpenModal(cat)} className="text-indigo-600 hover:text-indigo-900 ml-4">{t('edit')}</button>
                                <button onClick={() => handleDelete(cat.id)} className="text-red-600 hover:text-red-900">{t('delete')}</button>
                            </td>
                        </tr>
                        {cat.children && cat.children.map(child => renderCategoryRow(child, level + 1))}
                    </React.Fragment>
                );
            };

            return (
                 <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold">{t('manageCategories')}</h2>
                        <button onClick={() => handleOpenModal()} className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">{t('addCategory')}</button>
                    </div>
                    <div className="bg-white shadow rounded-lg overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('categoryName')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('action')}</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {categoryTree.map(cat => renderCategoryRow(cat))}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <Modal onClose={() => setShowModal(false)}>
                            <form onSubmit={handleSave} className="space-y-4">
                                <h3 className="text-lg font-bold">{editingCategory ? t('edit') : t('addCategory')}</h3>
                                <input type="text" placeholder={t('categoryName')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border rounded" required />
                                <select value={formData.parent_id || 'null'} onChange={e => setFormData({...formData, parent_id: e.target.value})} className="w-full p-2 border rounded">
                                    <option value='null'>{t('selectParentCategory')}</option>
                                    {categories.filter(c => !c.parent_id && c.id !== editingCategory?.id).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                <div className="flex justify-end gap-4">
                                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">{t('cancel')}</button>
                                    <button type="submit" className="px-4 py-2 bg-pink-600 text-white rounded">{t('save')}</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        const ProductManagement = ({ supabase, products, categories, fetchProducts, t, setNotification }) => {
            const [showModal, setShowModal] = useState(false); 
            const [editingProduct, setEditingProduct] = useState(null); 
            const [formData, setFormData] = useState({ name: '', description: '', price: '', sale_price: '', image_url: '', category_id: '' });
            const [imageFile, setImageFile] = useState(null);
            
            const handleOpenModal = (product = null) => { 
                setEditingProduct(product); 
                setImageFile(null);
                setFormData(product ? { ...product, sale_price: product.sale_price || '', category_id: product.category_id || '' } : { name: '', description: '', price: '', sale_price: '', image_url: '', category_id: '' }); 
                setShowModal(true); 
            };
            
            const handleSave = async (e) => {
                e.preventDefault(); 
                let imageUrl = formData.image_url;

                if (imageFile) {
                    const fileName = `${Date.now()}-${imageFile.name}`;
                    const { data, error } = await supabase.storage
                        .from('products')
                        .upload(fileName, imageFile);
                    
                    if(error) {
                        console.error("Image upload error:", error);
                        if(error.message === 'Bucket not found') {
                            setNotification({ type: 'error', messageKey: 'bucketNotFound_admin'});
                        }
                        return;
                    }

                    const { data: { publicUrl } } = supabase.storage
                        .from('products')
                        .getPublicUrl(data.path);
                    imageUrl = publicUrl;
                }

                const dataToSubmit = {
                    name: formData.name,
                    description: formData.description,
                    price: parseFloat(formData.price), 
                    sale_price: formData.sale_price ? parseFloat(formData.sale_price) : null, 
                    image_url: imageUrl,
                    category_id: formData.category_id ? parseInt(formData.category_id, 10) : null 
                };

                let error; 
                if (editingProduct) { 
                    ({ error } = await supabase.from('products').update(dataToSubmit).eq('id', editingProduct.id)); 
                } else { 
                    ({ error } = await supabase.from('products').insert(dataToSubmit)); 
                }
                if (!error) { 
                    fetchProducts(); 
                    setShowModal(false); 
                } else {
                    console.error("Supabase error:", error);
                }
            };
            const handleDelete = async (productId) => { 
                if(window.confirm(t('confirmDelete'))) { 
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', productId); 
                    if(!error) {
                        fetchProducts(); 
                    } else {
                        console.error("Error deleting product:", error);
                        alert('حدث خطأ أثناء حذف المنتج: ' + error.message);
                    }
                } 
            };
            
            return ( 
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold">{t('manageProducts')}</h2>
                        <button onClick={() => handleOpenModal()} className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">{t('addProduct')}</button>
                    </div>
                    <div className="bg-white shadow rounded-lg overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('productName')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('price')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('action')}</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {products.map(p => (
                                <tr key={p.id}>
                                    <td className="px-6 py-4 whitespace-nowrap">{p.name}</td>
                                    <td className="px-6 py-4 whitespace-nowrap">{p.price} {t('currency')}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onClick={() => handleOpenModal(p)} className="text-indigo-600 hover:text-indigo-900 ml-4">{t('edit')}</button>
                                        <button onClick={() => handleDelete(p.id)} className="text-red-600 hover:text-red-900">{t('delete')}</button>
                                    </td>
                                </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showModal && <Modal onClose={() => setShowModal(false)}>
                        <form onSubmit={handleSave} className="space-y-4">
                            <h3 className="text-lg font-bold">{editingProduct ? t('edit') : t('addProduct')}</h3>
                            
                            <div>
                               <label className="block text-sm font-medium text-gray-700 mb-1">{t('uploadImage')}</label>
                               <input type="file" accept="image/*" onChange={e => setImageFile(e.target.files[0])} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"/>
                               {imageFile ? <span className="text-sm text-gray-600">{imageFile.name}</span> : (editingProduct && formData.image_url) ? <span className="text-sm text-gray-600">صورة حالية موجودة. اختر ملفًا جديدًا لتغييرها.</span> : <span className="text-sm text-gray-500">{t('noImageSelected')}</span>}
                            </div>

                            <input type="text" placeholder={t('productName')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border rounded" required/>
                            
                            <textarea placeholder={t('productDesc')} value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full p-2 border rounded" rows="4"></textarea>

                            <input type="number" step="0.01" placeholder={t('price')} value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className="w-full p-2 border rounded" required/>

                            <input type="number" step="0.01" placeholder={t('salePrice')} value={formData.sale_price} onChange={e => setFormData({...formData, sale_price: e.target.value})} className="w-full p-2 border rounded"/>
                           
                            <select value={formData.category_id || ''} onChange={e => setFormData({...formData, category_id: e.target.value})} className="w-full p-2 border rounded">
                                <option value="">{t('category')}</option>
                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                            <div className="flex justify-end gap-4">
                                <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">{t('cancel')}</button>
                                <button type="submit" className="px-4 py-2 bg-pink-600 text-white rounded">{t('save')}</button>
                            </div>
                        </form>
                    </Modal>}
                </div> 
            );
        };
        const UserManagement = ({ supabase, users, fetchUsers, t }) => {
            const toggleBlockUser = async (user) => { const { error } = await supabase.from('profiles').update({ is_blocked: !user.is_blocked }).eq('id', user.id); if(!error) fetchUsers(); };
            return ( <div><h2 className="text-2xl font-bold mb-4">{t('manageUsers')}</h2><div className="bg-white shadow rounded-lg overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('fullName')}</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('userEmail')}</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('status')}</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('action')}</th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{users.map(u => (<tr key={u.id}><td className="px-6 py-4 whitespace-nowrap">{u.full_name || 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap">{u.email}</td><td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.is_blocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>{u.is_blocked ? t('blocked') : t('active')}</span></td><td className="px-6 py-4 whitespace-nowrap"><button onClick={() => toggleBlockUser(u)} className={`px-4 py-2 text-sm rounded-lg text-white ${u.is_blocked ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>{u.is_blocked ? t('unblock') : t('block')}</button></td></tr>))}</tbody></table></div></div> );
        };
        const AnalyticsDashboard = ({ supabase, orders, products, categories, t }) => {
            const analytics = useMemo(() => {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const ordersForPeriod = orders.filter(o => new Date(o.created_at) > thirtyDaysAgo);
                
                const totalSales = ordersForPeriod.reduce((sum, o) => sum + o.total, 0);
                const productSales = {}; ordersForPeriod.forEach(o => { o.items?.forEach(item => { productSales[item.product_id] = (productSales[item.product_id] || 0) + item.quantity; }); });
                const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b - a); const mostSold = sortedProducts.slice(0, 5).map(([id, q]) => ({ ...products.find(p => p.id == id), quantity: q })); const leastSold = sortedProducts.slice(-5).map(([id, q]) => ({ ...products.find(p => p.id == id), quantity: q }));
                const customerSales = {}; ordersForPeriod.forEach(o => { customerSales[o.user_id] = (customerSales[o.user_id] || 0) + o.total; }); const topCustomers = Object.entries(customerSales).sort(([, a], [, b]) => b - a).slice(0, 5);
                const categorySales = {}; categories.forEach(c => categorySales[c.id] = { name: c.name, total: 0 }); ordersForPeriod.forEach(o => { o.items?.forEach(item => { const product = products.find(p => p.id === item.product_id); if (product && categorySales[product.category_id]) { categorySales[product.category_id].total += item.price * item.quantity; } }); });
                return { totalSales, mostSold, leastSold, topCustomers, categorySales: Object.values(categorySales) };
            }, [orders, products, categories]);

            return ( 
              <div>
                <h2 className="text-2xl font-bold mb-4">{t('salesAnalytics')}</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-600">{t('totalSales30d')}</h3>
                        <p className="text-3xl font-extrabold text-pink-600 mt-2">{analytics.totalSales.toFixed(2)} {t('currency')}</p>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow md:col-span-2"><h3 className="font-bold text-gray-600">{t('smartTips')}</h3><p className="text-lg text-indigo-700 mt-2">{useMemo(() => { if (analytics.mostSold.length > 0 && analytics.mostSold[0]?.name) return t('tip1').replace('%s', analytics.mostSold[0].name); const sortedCategories = [...analytics.categorySales].sort((a, b) => a.total - b.total); if(sortedCategories.length > 0 && sortedCategories[0].total === 0) return t('tip2').replace('%s', sortedCategories[0].name); return t('tip3'); }, [analytics])}</p></div>
                    <div className="bg-white p-6 rounded-lg shadow"><h3 className="font-bold text-gray-600">{t('mostSold')}</h3><ul className="mt-2 space-y-1">{analytics.mostSold.map(p => p.name && <li key={p.id} className="flex justify-between"><span>{p.name}</span> <span className="font-semibold">{p.quantity}</span></li>)}</ul></div>
                    <div className="bg-white p-6 rounded-lg shadow"><h3 className="font-bold text-gray-600">{t('leastSold')}</h3><ul className="mt-2 space-y-1">{analytics.leastSold.map(p => p.name && <li key={p.id} className="flex justify-between"><span>{p.name}</span> <span className="font-semibold">{p.quantity}</span></li>)}</ul></div>
                    <div className="bg-white p-6 rounded-lg shadow"><h3 className="font-bold text-gray-600">{t('salesByCategory')}</h3><ul className="mt-2 space-y-1">{analytics.categorySales.map(c => <li key={c.name} className="flex justify-between"><span>{c.name}</span> <span className="font-semibold">{c.total.toFixed(2)} {t('currency')}</span></li>)}</ul></div>
                </div>
              </div> 
            );
        };
        const OrderManagement = ({ supabase, orders, fetchAllData, t }) => {
            const [selectedOrder, setSelectedOrder] = useState(null);

            const updateStatus = async (orderId, newStatus) => {
                const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
                if (!error) {
                    fetchAllData();
                } else {
                    console.error("Error updating status:", error);
                }
            };
            
            return (
                <div>
                     <h2 className="text-2xl font-bold mb-4">{t('manageOrders')}</h2>
                     <div className="bg-white shadow rounded-lg overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('orderNumber')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('customerName')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('finalTotal')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('orderStatus')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{t('action')}</th>
                                </tr>
                            </thead>
                             <tbody className="bg-white divide-y divide-gray-200">
                                {orders.map(o => (
                                    <tr key={o.id}>
                                        <td className="px-6 py-4 whitespace-nowrap">#{String(o.id).slice(0,8)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{o.shipping_details?.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{o.total.toFixed(2)} {t('currency')}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <select value={o.status} onChange={(e) => updateStatus(o.id, e.target.value)} className="p-1 border rounded-md">
                                                <option value="new">{t('newStatus')}</option>
                                                <option value="shipped">{t('shippedStatus')}</option>
                                                <option value="delivered">{t('deliveredStatus')}</option>
                                            </select>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                             <button onClick={() => setSelectedOrder(o)} className="text-indigo-600 hover:text-indigo-900">{t('orderDetails')}</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {selectedOrder && <Modal onClose={() => setSelectedOrder(null)}>
                        <h3 className="text-xl font-bold mb-4">{t('orderDetails')}</h3>
                        <div className="space-y-2 mb-4 border-b pb-4">
                            <p><strong>{t('orderNumber')}:</strong> #{String(selectedOrder.id).slice(0,8)}</p>
                            <p><strong>{t('customerName')}:</strong> {selectedOrder.shipping_details.name}</p>
                            <p><strong>{t('customerPhone')}:</strong> {selectedOrder.shipping_details.phone}</p>
                            <p><strong>{t('city')}:</strong> {selectedOrder.shipping_details.city}</p>
                             <p><strong>{t('addressPlaceholder')}:</strong> {selectedOrder.shipping_details.detailedAddress}</p>
                        </div>
                         <div className="space-y-2">
                             {selectedOrder.items.map((item, index) => (
                                 <div key={index} className="flex justify-between items-center">
                                     <span>{item.name} (x{item.quantity})</span>
                                     <span>{(item.price * item.quantity).toFixed(2)} {t('currency')}</span>
                                 </div>
                             ))}
                              <div className="flex justify-between border-t pt-2 mt-2">
                                 <span>{t('deliveryFee')}</span>
                                 <span>{selectedOrder.shipping_details.delivery_fee.toFixed(2)} {t('currency')}</span>
                             </div>
                             <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                                 <span>{t('finalTotal')}</span>
                                 <span>{selectedOrder.total.toFixed(2)} {t('currency')}</span>
                             </div>
                         </div>
                    </Modal>}
                </div>
            )
        };
        const CouponManagement = ({ supabase, coupons, fetchAllData, t }) => {
            const [showModal, setShowModal] = useState(false);
            const [editingCoupon, setEditingCoupon] = useState(null);
            const [formData, setFormData] = useState({
                code: '',
                discount_percentage: '',
                max_users: '',
                uses_per_user: '',
                is_active: true
            });

            const handleOpenModal = (coupon = null) => {
                setEditingCoupon(coupon);
                setFormData(coupon ? { ...coupon } : {
                    code: '',
                    discount_percentage: '10',
                    max_users: '100',
                    uses_per_user: '1',
                    is_active: true
                });
                setShowModal(true);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const dataToSubmit = {
                    ...formData,
                    code: formData.code.toUpperCase(),
                    discount_percentage: parseInt(formData.discount_percentage, 10),
                    max_users: parseInt(formData.max_users, 10),
                    uses_per_user: parseInt(formData.uses_per_user, 10)
                };

                let error;
                if (editingCoupon) {
                    ({ error } = await supabase.from('discount_codes').update(dataToSubmit).eq('id', editingCoupon.id));
                } else {
                    ({ error } = await supabase.from('discount_codes').insert(dataToSubmit));
                }

                if (!error) {
                    fetchAllData();
                    setShowModal(false);
                } else {
                    console.error("Supabase error:", error);
                    alert("Error saving coupon: " + error.message);
                }
            };

            const handleDelete = async (couponId) => {
                if (window.confirm(t('confirmDelete'))) {
                    const { error } = await supabase.from('discount_codes').delete().eq('id', couponId);
                    if (!error) fetchAllData();
                    else console.error(error);
                }
            };
            
            const toggleActive = async (coupon) => {
                const { error } = await supabase.from('discount_codes').update({ is_active: !coupon.is_active }).eq('id', coupon.id);
                if(!error) fetchAllData();
                else console.error(error);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold">{t('manageCoupons')}</h2>
                        <button onClick={() => handleOpenModal()} className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700">{t('addCoupon')}</button>
                    </div>
                    <div className="bg-white shadow rounded-lg overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('couponCode')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('discountPercentage')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('status')}</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{t('action')}</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {coupons.map(c => (
                                    <tr key={c.id}>
                                        <td className="px-6 py-4 whitespace-nowrap font-mono">{c.code}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{c.discount_percentage}%</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <button onClick={() => toggleActive(c)} className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                {c.is_active ? t('active') : t('blocked')}
                                            </button>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onClick={() => handleOpenModal(c)} className="text-indigo-600 hover:text-indigo-900 ml-4">{t('edit')}</button>
                                            <button onClick={() => handleDelete(c.id)} className="text-red-600 hover:text-red-900">{t('delete')}</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <Modal onClose={() => setShowModal(false)}>
                            <form onSubmit={handleSave} className="space-y-4">
                                <h3 className="text-lg font-bold">{editingCoupon ? t('edit') : t('addCoupon')}</h3>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('couponCode')}</label>
                                    <input type="text" value={formData.code} onChange={e => setFormData({...formData, code: e.target.value.toUpperCase()})} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('discountPercentage')}</label>
                                    <input type="number" min="1" max="100" value={formData.discount_percentage} onChange={e => setFormData({...formData, discount_percentage: e.target.value})} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('maxUsers')}</label>
                                    <input type="number" min="1" value={formData.max_users} onChange={e => setFormData({...formData, max_users: e.target.value})} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{t('usesPerUser')}</label>
                                    <input type="number" min="1" value={formData.uses_per_user} onChange={e => setFormData({...formData, uses_per_user: e.target.value})} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required />
                                </div>
                                <div className="flex justify-end gap-4">
                                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">{t('cancel')}</button>
                                    <button type="submit" className="px-4 py-2 bg-pink-600 text-white rounded">{t('save')}</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        const AdminDashboard = ({ supabase, t, setNotification }) => { 
            const [adminPage, setAdminPage] = useState('orders'); const [products, setProducts] = useState([]); const [categories, setCategories] = useState([]); const [users, setUsers] = useState([]); const [orders, setOrders] = useState([]); const [loading, setLoading] = useState(true);
            const [coupons, setCoupons] = useState([]);

            const fetchAllData = async () => {
                setLoading(true);
                const [productsRes, categoriesRes, usersRes, ordersRes, couponsRes] = await Promise.all([ 
                    supabase.from('products').select('*'), 
                    supabase.from('categories').select('*'), 
                    supabase.rpc('get_all_users_with_profiles'),
                    supabase.from('orders').select('*').order('created_at', { ascending: false }),
                    supabase.from('discount_codes').select('*')
                ]);
                setProducts(productsRes.data || []); setCategories(categoriesRes.data || []); setUsers(usersRes.data || []); setOrders(ordersRes.data || []); 
                setCoupons(couponsRes.data || []);
                setLoading(false);
            };
            useEffect(() => { if(supabase) fetchAllData(); }, [supabase]);
            const renderAdminPage = () => { 
                if (loading) return <div className="flex justify-center items-center p-10"><LoadingSpinner/></div>; 
                switch(adminPage) { 
                    case 'products': return <ProductManagement supabase={supabase} products={products} categories={categories} fetchProducts={fetchAllData} t={t} setNotification={setNotification} />; 
                    case 'categories': return <CategoryManagement supabase={supabase} categories={categories} fetchAllData={fetchAllData} t={t} setNotification={setNotification} />;
                    case 'users': return <UserManagement supabase={supabase} users={users} fetchUsers={fetchAllData} t={t} />; 
                    case 'orders': return <OrderManagement supabase={supabase} orders={orders} fetchAllData={fetchAllData} t={t} />;
                    case 'analytics': return <AnalyticsDashboard supabase={supabase} orders={orders} products={products} categories={categories} t={t} />; 
                    case 'coupons': return <CouponManagement supabase={supabase} coupons={coupons} fetchAllData={fetchAllData} t={t} />;
                    default: return <div>Welcome to the dashboard.</div> 
                } 
            };
            return ( <div className="container mx-auto p-4 sm:p-6 lg:p-8"><h1 className="text-3xl font-bold mb-6">{t('adminPanel')}</h1><div className="flex flex-col md:flex-row gap-8"><aside className="md:w-1/4"><nav className="flex flex-col space-y-2">{['orders', 'analytics', 'products', 'categories', 'users', 'coupons'].map(page => ( <button key={page} onClick={() => setAdminPage(page)} className={`w-full text-right px-4 py-2 rounded-lg font-semibold ${adminPage === page ? 'bg-pink-600 text-white' : 'bg-white hover:bg-pink-50'}`}>{t(page)}</button> ))}</nav></aside><main className="flex-grow md:w-3/4">{renderAdminPage()}</main></div></div> );
        };

        function App() {
            const [supabase, setSupabase] = useState(null); const [user, setUser] = useState(null); const [isAdmin, setIsAdmin] = useState(false); const [loading, setLoading] = useState(true); const [page, setPage] = useState('home'); const [selectedProductId, setSelectedProductId] = useState(null); const [searchTerm, setSearchTerm] = useState(''); const [language, setLanguage] = useState('ar');
            const [products, setProducts] = useState([]); 
            const [categories, setCategories] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [cart, setCart] = useState([]);
            const [notification, setNotification] = useState({ type: '', messageKey: '' });
            const t = useMemo(() => (key) => translations[language][key] || key, [language]);
            const toggleLanguage = () => setLanguage(prev => prev === 'ar' ? 'en' : 'ar');
            
            useEffect(() => { if (window.supabase) { setSupabase(window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)); } else { console.error("Supabase client not found."); } }, []);
            
            useEffect(() => {
                if (!supabase) return;
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => { 
                    const currentUser = session?.user;
                    setUser(currentUser ?? null); 
                    const adminStatus = currentUser?.email === ADMIN_EMAIL;
                    setIsAdmin(adminStatus);
                    if (event === "SIGNED_IN") {
                       if (adminStatus) {
                           setPage('dashboard');
                       } else {
                           setPage('home');
                       }
                    }
                });
                return () => subscription.unsubscribe();
            }, [supabase]);

            useEffect(() => {
                if (!supabase) return; let isMounted = true;
                const fetchInitialData = async () => {
                    const { data: productsData, error: productsError } = await supabase.from('products').select('*');
                    const { data: categoriesData, error: categoriesError } = await supabase.from('categories').select('*');
                    
                    if (isMounted) { 
                        if (productsData) setProducts(productsData); 
                        if (productsError) console.error("Error fetching products:", productsError); 
                        if (categoriesData) setCategories(categoriesData);
                        if (categoriesError) console.error("Error fetching categories:", categoriesError);
                        setLoading(false); 
                    }
                };
                fetchInitialData();
            }, [supabase]);

            useEffect(() => {
                if (!user || !supabase) { setCart([]); return; }
                const fetchCart = async () => { const { data } = await supabase.from('cart_items').select('*, products(*)').eq('user_id', user.id); if (data) setCart(data.filter(i => i.products)); };
                fetchCart();
            }, [user, supabase]);

            const handleLogout = async () => { if (supabase) { await supabase.auth.signOut(); setPage('home'); setNotification({ type: 'success', messageKey: 'logoutSuccess' }); } };
            
            const addToCart = async (product) => { 
                if (!supabase || !user) { 
                    setNotification({ type: 'error', messageKey: 'loginToAdd' }); 
                    setPage('auth'); 
                    return; 
                } 
                
                const existingItem = cart.find(item => item.product_id === product.id); 
                
                if (existingItem) { 
                    const newQuantity = existingItem.quantity + 1;
                    setCart(currentCart => currentCart.map(item => item.product_id === product.id ? {...item, quantity: newQuantity} : item));
                    const { error } = await supabase.from('cart_items').update({ quantity: newQuantity }).match({ user_id: user.id, product_id: product.id }); 
                    if (!error) setNotification({ type: 'success', messageKey: 'addedToCart' });
                } else { 
                    const newItem = { user_id: user.id, product_id: product.id, quantity: 1, products: product };
                    setCart(currentCart => [...currentCart, newItem]);
                    const { error } = await supabase.from('cart_items').insert({ user_id: user.id, product_id: product.id, quantity: 1 });
                    if (!error) setNotification({ type: 'success', messageKey: 'addedToCart' });
                } 
            };
            
            const updateCartQuantity = async (productId, newQuantity) => { 
                if (!supabase || !user) return; 
                setCart(currentCart => currentCart.map(item => item.product_id === productId ? {...item, quantity: newQuantity} : item).filter(item => item.quantity > 0));
                
                if (newQuantity < 1) {
                    await supabase.from('cart_items').delete().match({ product_id: productId, user_id: user.id });
                } else {
                    await supabase.from('cart_items').update({ quantity: newQuantity }).match({ product_id: productId, user_id: user.id }); 
                }
            };
            
            const removeFromCart = async (productId) => { 
                if (!supabase || !user) return;
                setCart(currentCart => currentCart.filter(item => item.product_id !== productId));
                await supabase.from('cart_items').delete().match({ product_id: productId, user_id: user.id });
            };
            const handleProductClick = (productId) => { setSelectedProductId(productId); setPage('productDetail'); };

            if (loading) return <LoadingSpinner />;
            
            const renderPage = () => {
                switch(page) {
                    case 'auth': return <AuthPage supabase={supabase} setNotification={setNotification} t={t} />;
                    case 'dashboard': return isAdmin ? <AdminDashboard supabase={supabase} t={t} setNotification={setNotification} /> : <HomePage products={products} categories={categories} selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory} searchTerm={searchTerm} onProductClick={handleProductClick} onAddToCart={addToCart} t={t} />;
                    case 'cart': return <CartPage supabase={supabase} cart={cart} updateQuantity={updateCartQuantity} removeFromCart={removeFromCart} setNotification={setNotification} user={user} setPage={setPage} t={t} />;
                    case 'productDetail': return <ProductDetailPage productId={selectedProductId} products={products} addToCart={addToCart} setNotification={setNotification} t={t} />;
                    case 'account': return user ? <AccountPage supabase={supabase} user={user} t={t} /> : <AuthPage supabase={supabase} setNotification={setNotification} t={t} />;
                    default: return <HomePage products={products} categories={categories} selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory} searchTerm={searchTerm} onProductClick={handleProductClick} onAddToCart={addToCart} t={t} />;
                }
            };

            return (
                <div dir={language === 'ar' ? 'rtl' : 'ltr'} className="font-sans bg-gray-50 text-gray-800 flex flex-col min-h-screen">
                    <Toast message={t(notification.messageKey)} type={notification.type} onClose={() => setNotification({ type: '', messageKey: '' })} />
                    <Header user={user} isAdmin={isAdmin} onLogout={handleLogout} setPage={setPage} setSearchTerm={setSearchTerm} cartItemCount={cart.reduce((s, i) => s + i.quantity, 0)} t={t} toggleLanguage={toggleLanguage} language={language} />
                    <main className="flex-grow">{renderPage()}</main>
                    <Footer t={t} />
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

